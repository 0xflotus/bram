(function(c,d){'object'==typeof exports&&'undefined'!=typeof module?module.exports=d():'function'==typeof define&&define.amd?define(d):c.Bram=d()})(this,function(){'use strict';function c(N,O){return Array.isArray(N)&&!isNaN(+O)}function d(N){return Array.isArray(N)||'object'==typeof N}function e(N,O){var P=new Proxy(N,{get:function(Q,R){return B.observe(P,R),Q[R]},set:function(Q,R,S){var T=Q[R];// If the value hasn't changed, nothing else to do
return!(!F(S)&&d(S)&&(S=E(S)),Q[R]=S,S!==T)||(c(Q,R)?O({prop:D,index:+R,type:'set'},S):O({prop:R,type:'set'},S),!0)},deleteProperty:function(Q,R){return c(Q,R)&&O({prop:D,index:+R,type:'delete'}),!0}});return P}function f(N){return N?Object.keys(N).reduce(function(O,P){var Q=N[P];return O[P]=Array.isArray(Q)||'object'==typeof Q?E(Q):Q,O},N):N}function g(N,O){this.model=N,this.parent=O}function h(N,O,P){function Q(V){if(U++,T===U){var W=O[T];W(V,P),T=+S.shift()}return!T}function R(V){var W,X=A.call(V.attributes||[]);return(z.call(X,function(){if(W=Q(V),W)return!0}),!W)&&(z.call(V.childNodes,function(Y){return(W=Q(Y),!!W)||(W=!R(Y),!!W)||void 0}),!W)}var S=Object.keys(O),T=+S.shift(),U=0;R(N)}function j(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}function k(N){for(var U,O=0,P=N.length,Q=new j,R=!1,S='',T=0;O<P;){if(S=U,U=N[O],!R){if('{'===U){'{'==S&&(Q.hasBinding=!0,T=Q.raw.length,null!=Q.values[T]&&T++,Q.values[T]='',R=!0),O++;continue}else'{'==S&&(Q.raw+=S);Q.raw+=U}else{if('}'===U){'}'==S&&(R=!1),O++;continue}Q.values[T]+=U}O++}return Q.includesNonBindings=0<Q.raw.length,Q}function l(N,O,P){var Q=O.compute(N),R=function(){P(Q())};O.props().forEach(function(S){var T=N.readInTransaction(S);T.model,!1!==T.bindable&&T.reads.forEach(function(U){G(U[0],U[1],R)})}),R()}function m(N,O,P){var Q={};switch(N.nodeType){// Element
case 1:var R;if('TEMPLATE'===N.nodeName&&(R=n(N))){var S=k(N.getAttribute(R));S.hasBinding&&(S.throwIfMultiple(),Q[R]=!0,P[O.id]=function(U,V){'each'===R?I.each(U,V,S,U):l(V,S,I[R](U,V))})}break;// TextNode
case 3:var S=k(N.nodeValue);S.hasBinding&&(P[O.id]=function(U,V){l(V,S,I.text(U))});}y.call(N.attributes||[],function(U){if(O.id++,!Q[U.name]){var V=U.name,W=p(V),X=k(U.value);if(X.hasBinding)P[O.id]=function(aa,ba){return W?(aa.removeAttribute(V),void l(ba,X,I.prop(aa,W))):void l(ba,X,I.attr(aa,V))};else if(W)P[O.id]=function(aa){aa.removeAttribute(V),I.prop(aa,W)(U.value)};else if('on-'===V.substr(0,3)){var Y=V.substr(3);P[O.id]=function(aa,ba){aa.removeAttribute(V),I.event(aa,Y,ba,X)}}}});var T=N.childNodes;return y.call(T,function(U){O.id++,m(U,O,P)}),P}function n(N){var O;for(var P=0,Q=J.length;P<Q;P++)if(O=J[P],N.getAttribute(O))return O}function p(N){return N&&':'===N[0]&&N.substr(1)}function q(N){return class extends N{constructor(){super();var O=this.constructor;let P=O.template;P&&(this._hydrate=K(P)),this._hasRendered=!1,this.model={};let Q=O.events;Q&&!O._hasSetupEvents&&r(O);let R=!O._hasInstalledProps&&O.observedProperties;R&&(O._hasInstalledProps=!0,s(O,R,O.observedAttributes))}connectedCallback(){if(this._hydrate&&!this._hasRendered){F(this.model)||(this.model=E(this.model));var O=new g(this).add(this.model),P=this._hydrate(O),Q=this.constructor.renderMode;'light'===Q?this.appendChild(P):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(P))}this.childrenConnectedCallback&&(this._disconnectChildMO=u(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO()}attributeChangedCallback(O,P,Q){var R=this.constructor._syncedAttrs,S=R&&R[O];S&&this[O]!==Q&&(this[O]=Q)}}}function r(N){N._hasSetupEvents=!0,N.events.forEach(function(O){Object.defineProperty(N.prototype,'on'+O,{get:function(){return this['_on'+O]},set:function(P){var Q='_on'+O,R=this[Q];R&&this.removeEventListener(O,R),this[Q]=P,this.addEventListener(O,P)}})})}function s(N,O,P=[]){N._syncedAttrs={};var Q=N.prototype;O.forEach(function(R){var S=Object.getOwnPropertyDescriptor(Q,R);if(!S){var T=-1!==P.indexOf(R);T&&(N._syncedAttrs[R]=!0),Object.defineProperty(Q,R,{get:function(){return this.model[R]},set:function(U){if(this.model[R]=U,T){var V=this.getAttribute(R);'boolean'==typeof U?U&&''!==V?this.setAttribute(R,''):''===V&&!U&&this.removeAttribute(R):V!==U&&this.setAttribute(R,U)}}})}})}function u(N){var O=!1,P=function(){O||N.childrenConnectedCallback()};if(!M)return void x(P);var Q=new MutationObserver(P);return Q.observe(N,{childList:!0}),N.childNodes.length&&x(P),function(){O=!0,Q.disconnect()}}var v='function'==typeof Symbol?Symbol:function(N){return'@@-'+N},w=Object.values||function(N){return Object.keys(N).reduce(function(O,P){return O.push(N[P]),O},[])},x='function'==typeof Promise?N=>Promise.resolve().then(N):N=>setTimeout(()=>N(),0),y=Array.prototype.forEach,z=Array.prototype.some,A=Array.prototype.slice;class B{static add(N){this.current=N,this.stack.push(N)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(N,O){this.current&&this.current.stack.push([N,O])}constructor(){this.stack=[]}start(){B.add(this)}stop(){return B.remove(),this.stack}}B.stack=[];var C=v('bram-events'),D=v('bram-array-change'),E=function(N,O){return F(N)?N:(N=f(N,O)||{},Object.defineProperty(N,C,{value:{},enumerable:!1}),e(N,function(P,Q){var R=N[C][P.prop];R&&R.forEach(function(S){S(P,Q)})}))},F=function(N){return N&&!!N[C]},G=function(N,O,P){var Q=N[C];if(Q){var R=Q[O];R||(R=Q[O]=[]),R.push(P)}},H=function(N,O,P){var Q=N[C];if(Q){var R=Q[O];if(R){var S=R.indexOf(P);-1===S||(R.splice(S,1),!R.length&&delete Q[O])}}};g.prototype.read=function(N){return this._read(N)||{model:this.model,value:void 0}},g.prototype.readInTransaction=function(N){var O=new B;O.start();var P=this.read(N);return P.reads=O.stop(),P},g.prototype._read=function(N){var O=this.model[N];return null==O?this.parent?this.parent.read(N):void 0:{model:this.model,value:O}},g.prototype.add=function(N){var O;return O=F(N)?N:Array.isArray(N)||'object'==typeof N?E(N):N,new g(O,this)},j.prototype.getValue=function(N){var O=this.props()[0];return N.read(O).value},j.prototype.getStringValue=function(N){for(var Q,R,O=Object.keys(this.values).sort(function(S,T){return+S>+T?1:-1}),P=this.raw;O.length;)Q=O.pop(),R=N.read(this.values[Q]).value,null!=R&&(P=P.substr(0,Q)+R+P.substr(Q));return P},j.prototype.compute=function(N){var O=this.includesNonBindings||1<this.count();return O?this.getStringValue.bind(this,N):this.getValue.bind(this,N)},j.prototype.props=function(){return w(this.values)},j.prototype.count=function(){return!1===this.hasBinding?0:Object.keys(this.values).length},j.prototype.throwIfMultiple=function(N){if(1<this.count())throw N=N||'Only a single binding is allowed in this context.',new Error(N)};var I={attr:function(N,O){return function(P){N.setAttribute(O,P)}},text:function(N){return function(O){N.nodeValue=O}},prop:function(N,O){return function(P){N[O]=P}},event:function(N,O,P,Q){var R=Q.raw;N.addEventListener(O,function(S){var T=P.read(R);T.value.call(T.model,S)})},each:function(N,O,P){var Q=K(N),R=P.props()[0],S=O.read(R),T=document.createTextNode('');N.parentNode.replaceChild(T,N);var U=function(W){var X=new Map,Y=new Map,Z=function(ba,ca){var da=O.add(ba).add({item:ba,index:ca}),ea=Q(da),fa={item:ba,nodes:A.call(ea.childNodes),scope:da,index:ca};X.set(ba,fa),Y.set(ca,fa);var ga=Y.get(ca+1),ha=T.parentNode;if(ga){var ia=ga.nodes[0];ha.insertBefore(ea,ia)}else ha.appendChild(ea)},$=function(ba){var ca=Y.get(ba);ca&&(ca.nodes.forEach(function(da){da.parentNode.removeChild(da)}),X.delete(ca.item),Y.delete(ba))};W.forEach(Z);var aa=function(ba,ca){if('delete'===ba.type)return void $(ba.index);var da=X.get(ca);if(da){var ea=da.index,fa=ea!==ba.index;if(fa){da.scope.model.index=da.index=ba.index;var ga=Y.get(ba.index);ga?Y.set(ea,ga):Y.delete(ea),Y.set(ba.index,da);var ha=Y.get(ba.index+1);ha&&(ha=ha.nodes[0]);for(var ia=da.nodes.length-1;0<=ia;)T.parentNode.insertBefore(da.nodes[ia],ha),ia--}}else $(ba.index),Z(ca,ba.index)};return G(W,D,aa),function(){for(var ba=0,ca=W.length;ba<ca;ba++)$(ba);H(W,D,aa),X=null,Y=null}},V=U(S.value);G(S.model,R,function(W,X){V(),V=U(X)})},if:function(N,O){var P=K(N),Q=!1,R={},S=document.createTextNode('');return N.parentNode.replaceChild(S,N),function(T){if(!!Q){var W=S.parentNode,X=S.nextSibling;T?R.children.forEach(function(Y){W.insertBefore(Y,X)}):R.children.forEach(function(Y){W.removeChild(Y)})}else if(T){var U=O.add(T),V=P(U);R.children=A.call(V.childNodes),R.scope=U,S.parentNode.insertBefore(V,S.nextSibling),Q=!0}}}},J=['if','each'],K=function(N){N=N instanceof HTMLTemplateElement?N:document.querySelector(N);var O=m(N.content,{id:0},{});return function(P){P instanceof g||(P=new g(P));var Q=document.importNode(N.content,!0);return h(Q,O,P),Q}},L=q(HTMLElement);q.Element=L,q.model=E,q.on=G,q.off=H,q.template=K;var M='function'==typeof MutationObserver;return q});

