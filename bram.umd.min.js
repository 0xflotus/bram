(function(c,d){'object'==typeof exports&&'undefined'!=typeof module?module.exports=d():'function'==typeof define&&define.amd?define(d):c.Bram=d()})(this,function(){'use strict';function c(M,N){return Array.isArray(M)&&!isNaN(+N)}function d(M){return Array.isArray(M)||'object'==typeof M}function e(M,N){var O=new Proxy(M,{get:function(P,Q){return A.observe(O,Q),P[Q]},set:function(P,Q,R){var S=P[Q];// If the value hasn't changed, nothing else to do
return!(!E(R)&&d(R)&&(R=D(R)),P[Q]=R,R!==S)||(c(P,Q)?N({prop:C,index:+Q,type:'set'},R):N({prop:Q,type:'set'},R),!0)},deleteProperty:function(P,Q){return c(P,Q)&&N({prop:C,index:+Q,type:'delete'}),!0}});return O}function f(M){return M?Object.keys(M).reduce(function(N,O){var P=M[O];return N[O]=Array.isArray(P)||'object'==typeof P?D(P):P,N},M):M}function g(M,N){this.model=M,this.parent=N}function h(M,N,O){function P(U){if(T++,S===T){var V=N[S];V(U,O),S=+R.shift()}return!S}function Q(U){var V,W=z.call(U.attributes||[]);return(y.call(W,function(){if(V=P(U),V)return!0}),!V)&&(y.call(U.childNodes,function(X){return(V=P(X),!!V)||(V=!Q(X),!!V)||void 0}),!V)}var R=Object.keys(N),S=+R.shift(),T=0;Q(M)}function j(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}function k(M){for(var T,N=0,O=M.length,P=new j,Q=!1,R='',S=0;N<O;){if(R=T,T=M[N],!Q){if('{'===T){'{'==R&&(P.hasBinding=!0,S=P.raw.length,null!=P.values[S]&&S++,P.values[S]='',Q=!0),N++;continue}else'{'==R&&(P.raw+=R);P.raw+=T}else{if('}'===T){'}'==R&&(Q=!1),N++;continue}P.values[S]+=T}N++}return P.includesNonBindings=0<P.raw.length,P}function l(M,N,O){var P=N.compute(M),Q=function(){O(P())};N.props().forEach(function(R){var S=M.readInTransaction(R);S.model,!1!==S.bindable&&S.reads.forEach(function(T){F(T[0],T[1],Q)})}),Q()}function m(M,N,O){var P={};switch(M.nodeType){// Element
case 1:var Q;if('TEMPLATE'===M.nodeName&&(Q=n(M))){var R=k(M.getAttribute(Q));R.hasBinding&&(R.throwIfMultiple(),P[Q]=!0,O[N.id]=function(T,U){'each'===Q?H.each(T,U,R,T):l(U,R,H[Q](T,U))})}break;// TextNode
case 3:var R=k(M.nodeValue);R.hasBinding&&(O[N.id]=function(T,U){l(U,R,H.text(T))});}x.call(M.attributes||[],function(T){if(N.id++,!P[T.name]){var U=T.name,V=p(U),W=k(T.value);if(W.hasBinding)O[N.id]=function($,aa){return V?($.removeAttribute(U),void l(aa,W,H.prop($,V))):void l(aa,W,H.attr($,U))};else if(V)O[N.id]=function($){$.removeAttribute(U),H.prop($,V)(T.value)};else if('on-'===U.substr(0,3)){var X=U.substr(3);O[N.id]=function($,aa){$.removeAttribute(U),H.event($,X,aa,W)}}}});var S=M.childNodes;return x.call(S,function(T){N.id++,m(T,N,O)}),O}function n(M){var N;for(var O=0,P=I.length;O<P;O++)if(N=I[O],M.getAttribute(N))return N}function p(M){return M&&':'===M[0]&&M.substr(1)}function q(M){return class extends M{constructor(){super();var N=this.constructor;let O=N.template;O&&(this._hydrate=J(O)),this._hasRendered=!1,this.model={};let P=N.events;P&&!N._hasSetupEvents&&r(N)}connectedCallback(){if(this._hydrate&&!this._hasRendered){E(this.model)||(this.model=D(this.model));var N=new g(this).add(this.model),O=this._hydrate(N),P=this.constructor.renderMode;'light'===P?this.appendChild(O):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(O))}this.childrenConnectedCallback&&(this._disconnectChildMO=s(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO()}}}function r(M){M._hasSetupEvents=!0,M.events().forEach(function(N){Object.defineProperty(M.prototype,'on'+N,{get:function(){return this['_on'+N]},set:function(O){var P='_on'+N,Q=this[P];Q&&this.removeEventListener(N,Q),this[P]=O,this.addEventListener(N,O)}})})}function s(M){var N=!1,O=function(){N||M.childrenConnectedCallback()};if(!L)return void w(O);var P=new MutationObserver(O);return P.observe(M,{childList:!0}),M.childNodes.length&&w(O),function(){N=!0,P.disconnect()}}var u='function'==typeof Symbol?Symbol:function(M){return'@@-'+M},v=Object.values||function(M){return Object.keys(M).reduce(function(N,O){return N.push(M[O]),N},[])},w='object'==typeof Promise?M=>Promise.resolve().then(M):M=>setTimeout(()=>M(),0),x=Array.prototype.forEach,y=Array.prototype.some,z=Array.prototype.slice;class A{static add(M){this.current=M,this.stack.push(M)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(M,N){this.current&&this.current.stack.push([M,N])}constructor(){this.stack=[]}start(){A.add(this)}stop(){return A.remove(),this.stack}}A.stack=[];var B=u('bram-events'),C=u('bram-array-change'),D=function(M,N){return M=f(M,N)||{},Object.defineProperty(M,B,{value:{},enumerable:!1}),e(M,function(O,P){var Q=M[B][O.prop];Q&&Q.forEach(function(R){R(O,P)})})},E=function(M){return M&&!!M[B]},F=function(M,N,O){var P=M[B];if(P){var Q=P[N];Q||(Q=P[N]=[]),Q.push(O)}},G=function(M,N,O){var P=M[B];if(P){var Q=P[N];if(Q){var R=Q.indexOf(O);-1===R||(Q.splice(R,1),!Q.length&&delete P[N])}}};g.prototype.read=function(M){return this._read(M)||{model:this.model,value:void 0}},g.prototype.readInTransaction=function(M){var N=new A;N.start();var O=this.read(M);return O.reads=N.stop(),O},g.prototype._read=function(M){var N=this.model[M];return null==N?this.parent?this.parent.read(M):void 0:{model:this.model,value:N}},g.prototype.add=function(M){var N;return N=E(M)?M:Array.isArray(M)||'object'==typeof M?D(M):M,new g(N,this)},j.prototype.getValue=function(M){var N=this.props()[0];return M.read(N).value},j.prototype.getStringValue=function(M){for(var P,Q,N=Object.keys(this.values).sort(function(R,S){return+R>+S?1:-1}),O=this.raw;N.length;)P=N.pop(),Q=M.read(this.values[P]).value,null!=Q&&(O=O.substr(0,P)+Q+O.substr(P));return O},j.prototype.compute=function(M){var N=this.includesNonBindings||1<this.count();return N?this.getStringValue.bind(this,M):this.getValue.bind(this,M)},j.prototype.props=function(){return v(this.values)},j.prototype.count=function(){return!1===this.hasBinding?0:Object.keys(this.values).length},j.prototype.throwIfMultiple=function(M){if(1<this.count())throw M=M||'Only a single binding is allowed in this context.',new Error(M)};var H={attr:function(M,N){return function(O){M.setAttribute(N,O)}},text:function(M){return function(N){M.nodeValue=N}},prop:function(M,N){return function(O){M[N]=O}},event:function(M,N,O,P){var Q=P.raw;M.addEventListener(N,function(R){var S=O.read(Q);S.value.call(S.model,R)})},each:function(M,N,O){var P=J(M),Q=O.props()[0],R=N.read(Q),S=document.createTextNode('');M.parentNode.replaceChild(S,M);var T=function(V){var W=new Map,X=new Map,Y=function(aa,ba){var ca=N.add(aa).add({item:aa,index:ba}),da=P(ca),ea={item:aa,nodes:z.call(da.childNodes),scope:ca,index:ba};W.set(aa,ea),X.set(ba,ea);var fa=X.get(ba+1),ga=S.parentNode;if(fa){var ha=fa.nodes[0];ga.insertBefore(da,ha)}else ga.appendChild(da)},Z=function(aa){var ba=X.get(aa);ba&&(ba.nodes.forEach(function(ca){ca.parentNode.removeChild(ca)}),W.delete(ba.item),X.delete(aa))};V.forEach(Y);var $=function(aa,ba){if('delete'===aa.type)return void Z(aa.index);var ca=W.get(ba);if(ca){var da=ca.index,ea=da!==aa.index;if(ea){ca.scope.model.index=ca.index=aa.index;var fa=X.get(aa.index);fa?X.set(da,fa):X.delete(da),X.set(aa.index,ca);var ga=X.get(aa.index+1);ga&&(ga=ga.nodes[0]);for(var ha=ca.nodes.length-1;0<=ha;)S.parentNode.insertBefore(ca.nodes[ha],ga),ha--}}else Z(aa.index),Y(ba,aa.index)};return F(V,C,$),function(){for(var aa=0,ba=V.length;aa<ba;aa++)Z(aa);G(V,C,$),W=null,X=null}},U=T(R.value);F(R.model,Q,function(V,W){U(),U=T(W)})},if:function(M,N){var O=J(M),P=!1,Q={},R=document.createTextNode('');return M.parentNode.replaceChild(R,M),function(S){if(!!P){var V=R.parentNode,W=R.nextSibling;S?Q.children.forEach(function(X){V.insertBefore(X,W)}):Q.children.forEach(function(X){V.removeChild(X)})}else if(S){var T=N.add(S),U=O(T);Q.children=z.call(U.childNodes),Q.scope=T,R.parentNode.insertBefore(U,R.nextSibling),P=!0}}}},I=['if','each'],J=function(M){M=M instanceof HTMLTemplateElement?M:document.querySelector(M);var N=m(M.content,{id:0},{});return function(O){O instanceof g||(O=new g(O));var P=document.importNode(M.content,!0);return h(P,N,O),P}},K=q(HTMLElement);q.Element=K,q.model=D,q.on=F,q.off=G,q.template=J;var L='function'==typeof MutationObserver;return q});

