(function(c,d){'object'==typeof exports&&'undefined'!=typeof module?module.exports=d():'function'==typeof define&&define.amd?define(d):c.Bram=d()})(this,function(){'use strict';function c(){return J=!0,d}function d(){J=!1;let ja=I;return I=[],ja}function e(ja,ka){J&&I.push([ja,ka])}function f(ja,ka){let la=ja[N];return la?!la[ka]&&(la[ka]=new L):(la=ja[N]=Object.create(null),la[ka]=new L),la[ka]}function g(ja,ka){return Array.isArray(ja)&&!isNaN(+ka)}function h(ja){return Array.isArray(ja)||'object'==typeof ja}function j(ja,ka){var la=new Proxy(ja,{get:function(ma,na){return H.observe(la,na),ma[na]},set:function(ma,na,oa){var pa=ma[na];// If the value hasn't changed, nothing else to do
return!(!V(oa)&&h(oa)&&(oa=U(oa)),ma[na]=oa,oa!==pa)||(g(ma,na)?ka({prop:T,index:+na,type:'set'},oa):ka({prop:na,type:'set'},oa),!0)},deleteProperty:function(ma,na){return g(ma,na)&&ka({prop:T,index:+na,type:'delete'}),!0}});return la}function k(ja){return ja?Object.keys(ja).reduce(function(ka,la){var ma=ja[la];return ka[la]=Array.isArray(ma)||'object'==typeof ma?U(ma):ma,ka},ja):ja}function l(ja,ka){this.model=ja,this.parent=ka}function n(ja,ka,la){function ma(ra){if(qa++,pa===qa){var ta=ka[pa];ta(ra,la,ja),pa=+oa.shift()}return!pa}function na(ra){var ta,ua=G.call(ra.attributes||[]);return(F.call(ua,function(){if(ta=ma(ra),ta)return!0}),!ta)&&(F.call(ra.childNodes,function(va){return(ta=ma(va),!!ta)||(ta=!na(va),!!ta)||void 0}),!ta)}var oa=Object.keys(ka),pa=+oa.shift(),qa=0;na(ja.tree)}function p(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}function q(ja){for(var qa,ka=0,la=ja.length,ma=new p,na=!1,oa='',pa=0;ka<la;){if(oa=qa,qa=ja[ka],!na){if('{'===qa){'{'==oa&&(ma.hasBinding=!0,pa=ma.raw.length,null!=ma.values[pa]&&pa++,ma.values[pa]='',na=!0),ka++;continue}else'{'==oa&&(ma.raw+=oa);ma.raw+=qa}else{if('}'===qa){'}'==oa&&(na=!1),ka++;continue}ma.values[pa]+=qa}ka++}return ma.includesNonBindings=0<ma.raw.length,ma}function r(ja,ka,la,ma){var na=ka.compute(ja),oa=function(){ma(na())};ka.props().forEach(function(pa){var qa=ja.readInTransaction(pa);qa.model,!1!==qa.bindable&&qa.reads.forEach(function(ra){la.on(ra[0],ra[1],oa)})}),oa()}function s(ja,ka){ka.renders.push(ja)}function u(ja,ka,la){var ma={};switch(ja.nodeType){// Element
case 1:var na;if('TEMPLATE'===ja.nodeName&&(na=v(ja))){var oa=q(ja.getAttribute(na));oa.hasBinding&&(oa.throwIfMultiple(),ma[na]=!0,la[ka.id]=function(qa,ra,ta){let ua=new Z(oa,ra);if('each'===na)Y.each(qa,ra,oa,ta);else{debugger;new ca(ua,qa,ta)}})}//setupBinding(model, result, link, live[templateAttr](node, model, link));
break;// TextNode
case 3:var oa=q(ja.nodeValue);oa.hasBinding&&(la[ka.id]=function(qa,ra,ta){let ua=new Z(oa,ra),va=new aa(ua,qa);s(va,ta),va.render()});}E.call(ja.attributes||[],function(qa){if(ka.id++,!ma[qa.name]){var ra=qa.name,ta=w(ra),ua=q(qa.value);if(ua.hasBinding)la[ka.id]=function(Ba,Ca,Da){if(ta)return Ba.removeAttribute(ra),void r(Ca,ua,Da,Y.prop(Ba,ta));let Ea=new Z(ua,Ca),Fa=new ba(Ea,Ba,ra);s(Fa,Da),Fa.render()};else if(ta)la[ka.id]=function(Ba){Ba.removeAttribute(ra),Y.prop(Ba,ta)(qa.value)};else if('on-'===ra.substr(0,3)){var va=ra.substr(3);la[ka.id]=function(Ba,Ca,Da){Ba.removeAttribute(ra),Y.event(Ba,va,Ca,ua,Da)}}}});var pa=ja.childNodes;return E.call(pa,function(qa){ka.id++,u(qa,ka,la)}),la}function v(ja){var ka;for(var la=0,ma=da.length;la<ma;la++)if(ka=da[la],ja.getAttribute(ka))return ka}function w(ja){return ja&&':'===ja[0]&&ja.substr(1)}function x(ja){return class extends ja{constructor(){super();var ka=this.constructor;let la=ka.template;la&&(this._hydrate=ga(la)),this._hasRendered=!1,this.model={};let ma=ka.events;ma&&!ka._hasSetupEvents&&y(ka);let na=!ka._hasInstalledProps&&ka.observedProperties;na&&(ka._hasInstalledProps=!0,z(ka,na,ka.observedAttributes))}connectedCallback(){if(this._hydrate&&!this._hasRendered){V(this.model)||(this.model=U(this.model));var ka=new l(this).add(this.model);this._link=this._hydrate(ka);var la=this._link.tree,ma=this.constructor.renderMode;'light'===ma?(this.innerHTML='',this.appendChild(la)):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(la)),this._hasRendered=!0}else this._hasRendered&&this._link.attach();this.childrenConnectedCallback&&(this._disconnectChildMO=A(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO(),this._link&&this._link.detach()}attributeChangedCallback(ka,la,ma){var na=this.constructor._syncedAttrs,oa=na&&na[ka];oa&&this[ka]!==ma&&(this[ka]=ma)}}}function y(ja){ja._hasSetupEvents=!0,ja.events.forEach(function(ka){Object.defineProperty(ja.prototype,'on'+ka,{get:function(){return this['_on'+ka]},set:function(la){var ma='_on'+ka,na=this[ma];na&&this.removeEventListener(ka,na),this[ma]=la,this.addEventListener(ka,la)}})})}function z(ja,ka,la=[]){ja._syncedAttrs={};var ma=ja.prototype;ka.forEach(function(na){var oa=Object.getOwnPropertyDescriptor(ma,na);if(!oa){var pa=-1!==la.indexOf(na);pa&&(ja._syncedAttrs[na]=!0),Object.defineProperty(ma,na,{get:function(){return this.model[na]},set:function(qa){if(this.model[na]=qa,pa){var ra=this.getAttribute(na);'boolean'==typeof qa?qa&&''!==ra?this.setAttribute(na,''):''===ra&&!qa&&this.removeAttribute(na):ra!==qa&&this.setAttribute(na,qa)}}})}})}function A(ja){var ka=!1,la=function(){ka||ja.childrenConnectedCallback()};if(!ia)return void D(la);var ma=new MutationObserver(la);return ma.observe(ja,{childList:!0}),ja.childNodes.length&&D(la),function(){ka=!0,ma.disconnect()}}var B='function'==typeof Symbol?Symbol:function(ja){return'@@-'+ja},C=Object.values||function(ja){return Object.keys(ja).reduce(function(ka,la){return ka.push(ja[la]),ka},[])},D='function'==typeof Promise?ja=>Promise.resolve().then(ja):ja=>setTimeout(()=>ja(),0),E=Array.prototype.forEach,F=Array.prototype.some,G=Array.prototype.slice;class H{static add(ja){this.current=ja,this.stack.push(ja)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(ja,ka){this.current&&this.current.stack.push([ja,ka])}constructor(){this.stack=[]}start(){H.add(this)}stop(){return H.remove(),this.stack}}H.stack=[];let I=[],J=!1,K=0;class L{constructor(){this.revision=K}dirty(){this.revision=++K}value(){return this.revision}}class M{constructor(ja){this.parents=ja.map(function(ka){return f(ka[0],ka[1])})}value(){return this.parents.reduce(function(ja,ka){let la=ka.value();return la>ja?la:ja},0)}}const N=B('bramTag');let O=[];var P=function(ja,ka){let la=f(ja,ka);la.dirty(),O.forEach(function(ma){for(var na=0,oa=ma.length;na<oa;na++)ma[na].rerender()})};let Q=null;Q='object'==typeof Reflect?Reflect:{get:function(ja,ka,la){let ma=Object.getOwnPropertyDescriptor(ja,ka);return void 0!==ma&&void 0!==ma.get?ma.get.call(la):ja[ka]}};var R=Q,S=B('bram-events'),T=B('bram-array-change'),U=function(ja,ka){return V(ja)?ja:(ja=k(ja,ka)||{},Object.defineProperty(ja,S,{value:{},enumerable:!1}),j(ja,function(la,ma){var na=ja[S][la.prop];na&&na.forEach(function(oa){oa(la,ma)})}))},V=function(ja){return ja&&!!ja[S]},W=function(ja,ka,la){var ma=ja[S];if(ma){var na=ma[ka];na||(na=ma[ka]=[]),na.push(la)}},X=function(ja,ka,la){var ma=ja[S];if(ma){var na=ma[ka];if(na){var oa=na.indexOf(la);-1===oa||(na.splice(oa,1),!na.length&&delete ma[ka])}}};U=function(ja){var ka=new Proxy(ja,{get:function(la,ma){return e(ka,ma),R.get(la,ma,ka)},set:function(la,ma,na){return la[ma]=na,P(la,ma),!0}});return ka},l.prototype.read=function(ja){return this._read(ja)||{model:this.model,value:void 0}},l.prototype.readInTransaction=function(ja){var ka=new H;ka.start();var la=this.read(ja);return la.reads=ka.stop(),la},l.prototype._read=function(ja){var ka=this.model,la=ka[ja];if(null==la){// Handle dotted bindings like "user.name"
var ma=ja.split('.');if(1<ma.length)do la=ka[ma.shift()],ma.length&&(ka=la);while(ma.length&&la)}return null==la?this.parent?this.parent.read(ja):void 0:{model:ka,value:la}},l.prototype.add=function(ja){var ka;return ka=V(ja)?ja:Array.isArray(ja)||'object'==typeof ja?U(ja):ja,new l(ka,this)},p.prototype.getValue=function(ja){var ka=this.props()[0];return ja.read(ka).value},p.prototype.getStringValue=function(ja){for(var ma,na,ka=Object.keys(this.values).sort(function(oa,pa){return+oa>+pa?1:-1}),la=this.raw;ka.length;)ma=ka.pop(),na=ja.read(this.values[ma]).value,null!=na&&(la=la.substr(0,ma)+na+la.substr(ma));return la},p.prototype.compute=function(ja){var ka=this.includesNonBindings||1<this.count();return ka?this.getStringValue.bind(this,ja):this.getValue.bind(this,ja)},p.prototype.props=function(){return C(this.values)},p.prototype.count=function(){return!1===this.hasBinding?0:Object.keys(this.values).length},p.prototype.throwIfMultiple=function(ja){if(1<this.count())throw ja=ja||'Only a single binding is allowed in this context.',new Error(ja)};var Y={attr:function(ja,ka){return function(la){ja.setAttribute(ka,la)}},text:function(ja){return function(ka){ja.nodeValue=ka}},prop:function(ja,ka){return function(la){ja[ka]=la}},event:function(ja,ka,la,ma,na){var oa=ma.raw;na.bind(ja,ka,function(pa){var qa=la.read(oa);qa.value.call(qa.model,pa)})},each:function(ja,ka,la,ma){var na=ga(ja),oa=la.props()[0],pa=ka.read(oa),qa=document.createTextNode('');ja.parentNode.replaceChild(qa,ja);var ra=function(ua){var va=new Map,wa=new Map,xa=function(Aa,Ba){var Ca=ka.add(Aa).add({item:Aa,index:Ba}),Da=na(Ca);ma.add(Da);var Ea=Da.tree,Fa={item:Aa,link:Da,nodes:G.call(Ea.childNodes),scope:Ca,index:Ba};va.set(Aa,Fa),wa.set(Ba,Fa);var Ga=wa.get(Ba+1),Ha=qa.parentNode;if(Ga){var Ia=Ga.nodes[0];Ha.insertBefore(Ea,Ia)}else Ha.appendChild(Ea)},ya=function(Aa){var Ba=wa.get(Aa);Ba&&(Ba.nodes.forEach(function(Ca){Ca.parentNode.removeChild(Ca)}),ma.remove(Ba.link),va.delete(Ba.item),wa.delete(Aa))};ua.forEach(xa);var za=function(Aa,Ba){if('delete'===Aa.type)return void ya(Aa.index);var Ca=va.get(Ba);if(Ca){var Da=Ca.index,Ea=Da!==Aa.index;if(Ea){Ca.scope.model.index=Ca.index=Aa.index;var Fa=wa.get(Aa.index);Fa?wa.set(Da,Fa):wa.delete(Da),wa.set(Aa.index,Ca);var Ga=wa.get(Aa.index+1);Ga&&(Ga=Ga.nodes[0]);for(var Ha=Ca.nodes.length-1;0<=Ha;)qa.parentNode.insertBefore(Ca.nodes[Ha],Ga),Ha--}}else ya(Aa.index),xa(Ba,Aa.index)};return ma.on(ua,T,za),function(){for(var Aa=0,Ba=ua.length;Aa<Ba;Aa++)ya(Aa);ma.off(ua,T,za),va=null,wa=null}},ta=ra(pa.value);ma.on(pa.model,oa,function(ua,va){ta(),ta=ra(va)})},if:function(ja,ka,la){var ma=ga(ja),na=!1,oa={},pa=document.createTextNode('');return ja.parentNode.replaceChild(pa,ja),function(qa){if(!!na){var va=pa.parentNode,wa=pa.nextSibling;qa?oa.children.forEach(function(xa){va.insertBefore(xa,wa)}):oa.children.forEach(function(xa){va.removeChild(xa)})}else if(qa){var ra=ka.add(qa),ta=ma(ra);la.add(ta);var ua=ta.tree;oa.children=G.call(ua.childNodes),oa.scope=ra,pa.parentNode.insertBefore(ua,pa.nextSibling),na=!0}}}};class Z{constructor(ja,ka){this.expr=ja,this.scope=ka,this._tag=null,this._checked=!1}get tag(){if(null===this._tag){let ja=this.expr.props()[0],ka=this.scope.read(ja);this._tag=f(ka.model,ja)}return this._tag}validate(ja){return this.tag.value()===ja}current(){return this.expr.getValue(this.scope)}value(){if(!this._checked){this._checked=!0;let ja=c(),ka=this.current(),la=ja();return 1<la.length&&(this._tag=new M(la)),ka}return this.current()}}class ${constructor(ja,ka){this.ref=ja,this.node=ka,this.lastTicket=null}render(){this.lastTicket=this.ref.tag.value()}rerender(){this.ref.validate(this.lastTicket)||this.render()}}class aa extends ${render(){this.node.nodeValue=this.ref.value(),super.render()}}class ba extends ${constructor(ja,ka,la){super(ja,ka),this.attrName=la}render(){let ja=this.ref.value();this.node.setAttribute(this.attrName,ja),super.render()}}class ca extends ${constructor(ja,ka,la){super(ja,ka),this.parentLink=la,this.hydrate=ga(ka),this.rendered=!1,this.child={},this.placeholder=document.createTextNode(''),ka.parentNode.replaceChild(placeholder,ka)}render(){var ja=this.hydrate,ka=this.rendered,la=this.ref.value(),ma=this.ref.scope;if(!!ka){var qa=placeholder.parentNode,ra=placeholder.nextSibling;la?child.children.forEach(function(ta){qa.insertBefore(ta,ra)}):child.children.forEach(function(ta){qa.removeChild(ta)})}else if(la){var na=ma.add(la),oa=ja(na);this.parentLink.add(oa);var pa=oa.tree;child.children=G.call(pa.childNodes),child.scope=na,placeholder.parentNode.insertBefore(pa,placeholder.nextSibling),ka=!0}super.render()}}var da=['if','each'];class ea{constructor(){this.map=new Map}set(ja,ka,la){let ma=this.map.get(ja);ma||(ma=new Map,this.map.set(ja,ma)),ma.set(ka,la)}delete(ja,ka){let la=this.map.get(ja);la&&la.delete(ka)}}class fa{constructor(ja){this.tree=ja,this.models=new ea,this.elements=new ea,this.renders=[],this.children=[]}loop(ja,ka){for(let[la,ma]of ja)ka(la,ma[0],ma[1])}on(ja,ka,la){this.models.set(ja,ka,la),W(ja,ka,la)}off(ja,ka,la){this.models.delete(ja,ka),X(ja,ka,la)}bind(ja,ka,la){this.elements.set(ja,ka,la),ja.addEventListener(ka,la)}attach(){this.loop(this.models,W),this.children.forEach(function(ja){ja.attach()})}detach(){this.loop(this.models,X),this.children.forEach(function(ja){ja.detach()})}add(ja){this.children.push(ja)}remove(ja){var ka=this.children.indexOf(ja);this.children.splice(ka,1)}}var ga=function(ja){ja=ja instanceof HTMLTemplateElement?ja:document.querySelector(ja);var ka=u(ja.content,{id:0},{});return function(la){la instanceof l||(la=new l(la));var ma=document.importNode(ja.content,!0),na=new fa(ma);return O.push(na.renders),n(na,ka,la),na}},ha=x(HTMLElement);x.Element=ha,x.model=U,x.on=W,x.off=X,x.template=ga;var ia='function'==typeof MutationObserver;return x});

