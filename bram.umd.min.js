(function(c,d){'object'==typeof exports&&'undefined'!=typeof module?module.exports=d():'function'==typeof define&&define.amd?define(d):c.Bram=d()})(this,function(){'use strict';function c(J,K){return Array.isArray(J)&&!isNaN(+K)}function d(J){return Array.isArray(J)||'object'==typeof J}function e(J,K){var L=new Proxy(J,{get:function(M,N){return y.observe(L,N),M[N]},set:function(M,N,O){var P=M[N];// If the value hasn't changed, nothing else to do
return(!C(O)&&d(O)&&(O=B(O)),M[N]=O,O===P)||(c(M,N)?K({prop:A,index:+N,type:'set'},O):K({prop:N,type:'set'},O),!0)},deleteProperty:function(M,N){return c(M,N)&&K({prop:A,index:+N,type:'delete'}),!0}});return L}function f(J){return J?Object.keys(J).reduce(function(K,L){var M=J[L];return K[L]=Array.isArray(M)||'object'==typeof M?B(M):M,K},J):J}function g(J,K){this.model=J,this.parent=K}function h(J,K,L){function M(R){if(Q++,P===Q){var S=K[P];S(R,L),P=+O.shift()}return!P}function N(R){var S,T=x.call(R.attributes||[]);return(w.call(T,function(){if(S=M(R),S)return!0}),!S)&&(w.call(R.childNodes,function(U){return(S=M(U),!!S)||(S=!N(U),!!S)||void 0}),!S)}var O=Object.keys(K),P=+O.shift(),Q=0;N(J)}function j(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}function k(J){for(var Q,K=0,L=J.length,M=new j,N=!1,O='',P=0;K<L;){if(O=Q,Q=J[K],!N){if('{'===Q){'{'==O&&(M.hasBinding=!0,P=M.raw.length,null!=M.values[P]&&P++,M.values[P]='',N=!0),K++;continue}else'{'==O&&(M.raw+=O);M.raw+=Q}else{if('}'===Q){'}'==O&&(N=!1),K++;continue}M.values[P]+=Q}K++}return M.includesNonBindings=0<M.raw.length,M}function l(J,K,L){var M=K.compute(J),N=function(){L(M())};K.props().forEach(function(O){var P=J.readInTransaction(O);P.model,!1!==P.bindable&&P.reads.forEach(function(Q){D(Q[0],Q[1],N)})}),N()}function m(J,K,L){var M={};switch(J.nodeType){// Element
case 1:var N;if('TEMPLATE'===J.nodeName&&(N=n(J))){var O=k(J.getAttribute(N));O.hasBinding&&(O.throwIfMultiple(),M[N]=!0,L[K.id]=function(Q,R){'each'===N?F.each(Q,R,O,Q):l(R,O,F[N](Q,R))})}break;// TextNode
case 3:var O=k(J.nodeValue);O.hasBinding&&(L[K.id]=function(Q,R){l(R,O,F.text(Q))});}v.call(J.attributes||[],function(Q){if(K.id++,!M[Q.name]){var R=Q.name,S=p(R),T=k(Q.value);if(T.hasBinding)L[K.id]=function(X,Y){return S?(X.removeAttribute(R),void l(Y,T,F.prop(X,S))):void l(Y,T,F.attr(X,R))};else if(S)L[K.id]=function(X){X.removeAttribute(R),F.prop(X,S)(Q.value)};else if('on-'===R.substr(0,3)){var U=R.substr(3);L[K.id]=function(X,Y){X.removeAttribute(R),F.event(X,U,Y,T)}}}});var P=J.childNodes;return v.call(P,function(Q){K.id++,m(Q,K,L)}),L}function n(J){var K;for(var L=0,M=G.length;L<M;L++)if(K=G[L],J.getAttribute(K))return K}function p(J){return J&&':'===J[0]&&J.substr(1)}function q(J){return class extends J{constructor(){super();var K=this.constructor;let L=K.template;L&&(this._hydrate=H(L)),this._hasRendered=!1,this.model={};let M=K.events;M&&!K._hasSetupEvents&&r(K)}connectedCallback(){if(this._hydrate&&!this._hasRendered){C(this.model)||(this.model=B(this.model));var K=new g(this).add(this.model),L=this._hydrate(K),M=this.constructor.renderMode;'light'===M?this.appendChild(L):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(L))}}}}function r(J){J._hasSetupEvents=!0,J.events().forEach(function(K){Object.defineProperty(J.prototype,'on'+K,{get:function(){return this['_on'+K]},set:function(L){var M='_on'+K,N=this[M];N&&this.removeEventListener(K,N),this[M]=L,this.addEventListener(K,L)}})})}var s='function'==typeof Symbol?Symbol:function(J){return'@@-'+J},u=Object.values||function(J){return Object.keys(J).reduce(function(K,L){return K.push(J[L]),K},[])},v=Array.prototype.forEach,w=Array.prototype.some,x=Array.prototype.slice;class y{static add(J){this.current=J,this.stack.push(J)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(J,K){this.current&&this.current.stack.push([J,K])}constructor(){this.stack=[]}start(){y.add(this)}stop(){return y.remove(),this.stack}}y.stack=[];var z=s('bram-events'),A=s('bram-array-change'),B=function(J,K){return J=f(J,K)||{},Object.defineProperty(J,z,{value:{},enumerable:!1}),e(J,function(L,M){var N=J[z][L.prop];N&&N.forEach(function(O){O(L,M)})})},C=function(J){return J&&!!J[z]},D=function(J,K,L){var M=J[z];if(M){var N=M[K];N||(N=M[K]=[]),N.push(L)}},E=function(J,K,L){var M=J[z];if(M){var N=M[K];if(N){var O=N.indexOf(L);-1===O||(N.splice(O,1),!N.length&&delete M[K])}}};g.prototype.read=function(J){return this._read(J)||{model:this.model,value:void 0}},g.prototype.readInTransaction=function(J){var K=new y;K.start();var L=this.read(J);return L.reads=K.stop(),L},g.prototype._read=function(J){var K=this.model[J];return null==K?this.parent?this.parent.read(J):void 0:{model:this.model,value:K}},g.prototype.add=function(J){var K;return K=C(J)?J:Array.isArray(J)||'object'==typeof J?B(J):J,new g(K,this)},j.prototype.getValue=function(J){var K=this.props()[0];return J.read(K).value},j.prototype.getStringValue=function(J){for(var M,N,K=Object.keys(this.values).sort(function(O,P){return+O>+P?1:-1}),L=this.raw;K.length;)M=K.pop(),N=J.read(this.values[M]).value,null!=N&&(L=L.substr(0,M)+N+L.substr(M));return L},j.prototype.compute=function(J){var K=this.includesNonBindings||1<this.count();return K?this.getStringValue.bind(this,J):this.getValue.bind(this,J)},j.prototype.props=function(){return u(this.values)},j.prototype.count=function(){return!1===this.hasBinding?0:Object.keys(this.values).length},j.prototype.throwIfMultiple=function(J){if(1<this.count())throw J=J||'Only a single binding is allowed in this context.',new Error(J)};var F={attr:function(J,K){return function(L){J.setAttribute(K,L)}},text:function(J){return function(K){J.nodeValue=K}},prop:function(J,K){return function(L){J[K]=L}},event:function(J,K,L,M){var N=M.raw;J.addEventListener(K,function(O){var P=L.read(N);P.value.call(P.model,O)})},each:function(J,K,L){var M=H(J),N=L.props()[0],O=K.read(N),P=document.createTextNode('');J.parentNode.replaceChild(P,J);var Q=function(S){var T=new Map,U=new Map,V=function(Y,Z){var $=K.add(Y).add({item:Y,index:Z}),_=M($),aa={item:Y,nodes:x.call(_.childNodes),scope:$,index:Z};T.set(Y,aa),U.set(Z,aa);var ba=U.get(Z+1),ca=P.parentNode;if(ba){var da=ba.nodes[0];ca.insertBefore(_,da)}else ca.appendChild(_)},W=function(Y){var Z=U.get(Y);Z&&(Z.nodes.forEach(function($){$.parentNode.removeChild($)}),T.delete(Z.item),U.delete(Y))};S.forEach(V);var X=function(Y,Z){if('delete'===Y.type)return void W(Y.index);var $=T.get(Z);if($){var _=$.index,aa=_!==Y.index;if(aa){$.scope.model.index=$.index=Y.index;var ba=U.get(Y.index);ba?U.set(_,ba):U.delete(_),U.set(Y.index,$);var ca=U.get(Y.index+1);ca&&(ca=ca.nodes[0]);for(var da=$.nodes.length-1;0<=da;)P.parentNode.insertBefore($.nodes[da],ca),da--}}else W(Y.index),V(Z,Y.index)};return D(S,A,X),function(){for(var Y=0,Z=S.length;Y<Z;Y++)W(Y);E(S,A,X),T=null,U=null}},R=Q(O.value);D(O.model,N,function(S,T){R(),R=Q(T)})},if:function(J,K){var L=H(J),M=!1,N={},O=document.createTextNode('');return J.parentNode.replaceChild(O,J),function(P){if(!!M){var S=O.parentNode,T=O.nextSibling;P?N.children.forEach(function(U){S.insertBefore(U,T)}):N.children.forEach(function(U){S.removeChild(U)})}else if(P){var Q=K.add(P),R=L(Q);N.children=x.call(R.childNodes),N.scope=Q,O.parentNode.insertBefore(R,O.nextSibling),M=!0}}}},G=['if','each'],H=function(J){J=J instanceof HTMLTemplateElement?J:document.querySelector(J);var K=m(J.content,{id:0},{});return function(L){L instanceof g||(L=new g(L));var M=document.importNode(J.content,!0);return h(M,K,L),M}},I=q(HTMLElement);return q.Element=I,q.model=B,q.on=D,q.off=E,q.template=H,q});

