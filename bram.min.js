var symbol='function'==typeof Symbol?Symbol:function(c){return'@@-'+c},values=Object.values||function(c){return Object.keys(c).reduce(function(d,e){return d.push(c[e]),d},[])},asap='object'==typeof Promise?c=>Promise.resolve().then(c):c=>setTimeout(()=>c(),0),forEach=Array.prototype.forEach,some=Array.prototype.some,slice=Array.prototype.slice;class Transaction{static add(c){this.current=c,this.stack.push(c)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(c,d){this.current&&this.current.stack.push([c,d])}constructor(){this.stack=[]}start(){Transaction.add(this)}stop(){return Transaction.remove(),this.stack}}Transaction.stack=[];function isArraySet(c,d){return Array.isArray(c)&&!isNaN(+d)}function isArrayOrObject(c){return Array.isArray(c)||'object'==typeof c}function observe(c,d){var e=new Proxy(c,{get:function(f,g){return Transaction.observe(e,g),f[g]},set:function(f,g,h){var j=f[g];// If the value hasn't changed, nothing else to do
return!(!isModel(h)&&isArrayOrObject(h)&&(h=toModel(h)),f[g]=h,h!==j)||(isArraySet(f,g)?d({prop:arrayChange,index:+g,type:'set'},h):d({prop:g,type:'set'},h),!0)},deleteProperty:function(f,g){return isArraySet(f,g)&&d({prop:arrayChange,index:+g,type:'delete'}),!0}});return e}var events=symbol('bram-events'),arrayChange=symbol('bram-array-change'),toModel=function(c,d){return c=deepModel(c,d)||{},Object.defineProperty(c,events,{value:{},enumerable:!1}),observe(c,function(e,f){var g=c[events][e.prop];g&&g.forEach(function(h){h(e,f)})})};function deepModel(c){return c?Object.keys(c).reduce(function(d,e){var f=c[e];return d[e]=Array.isArray(f)||'object'==typeof f?toModel(f):f,d},c):c}var isModel=function(c){return c&&!!c[events]},on=function(c,d,e){var f=c[events];if(f){var g=f[d];g||(g=f[d]=[]),g.push(e)}},off=function(c,d,e){var f=c[events];if(f){var g=f[d];if(g){var h=g.indexOf(e);-1===h||(g.splice(h,1),!g.length&&delete f[d])}}};function Scope(c,d){this.model=c,this.parent=d}Scope.prototype.read=function(c){return this._read(c)||{model:this.model,value:void 0}},Scope.prototype.readInTransaction=function(c){var d=new Transaction;d.start();var e=this.read(c);return e.reads=d.stop(),e},Scope.prototype._read=function(c){var d=this.model[c];return null==d?this.parent?this.parent.read(c):void 0:{model:this.model,value:d}},Scope.prototype.add=function(c){var d;return d=isModel(c)?c:Array.isArray(c)||'object'==typeof c?toModel(c):c,new Scope(d,this)};function hydrate(c,d,e){function f(l){if(k++,j===k){var m=d[j];m(l,e),j=+h.shift()}return!j}function g(l){var m,n=slice.call(l.attributes||[]);return(some.call(n,function(){if(m=f(l),m)return!0}),!m)&&(some.call(l.childNodes,function(p){return(m=f(p),!!m)||(m=!g(p),!!m)||void 0}),!m)}var h=Object.keys(d),j=+h.shift(),k=0;g(c)}function ParseResult(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}ParseResult.prototype.getValue=function(c){var d=this.props()[0];return c.read(d).value},ParseResult.prototype.getStringValue=function(c){for(var f,g,d=Object.keys(this.values).sort(function(h,j){return+h>+j?1:-1}),e=this.raw;d.length;)f=d.pop(),g=c.read(this.values[f]).value,null!=g&&(e=e.substr(0,f)+g+e.substr(f));return e},ParseResult.prototype.compute=function(c){var d=this.includesNonBindings||1<this.count();return d?this.getStringValue.bind(this,c):this.getValue.bind(this,c)},ParseResult.prototype.props=function(){return values(this.values)},ParseResult.prototype.count=function(){return!1===this.hasBinding?0:Object.keys(this.values).length},ParseResult.prototype.throwIfMultiple=function(c){if(1<this.count())throw c=c||'Only a single binding is allowed in this context.',new Error(c)};function parse(c){for(var k,d=0,e=c.length,f=new ParseResult,g=!1,h='',j=0;d<e;){if(h=k,k=c[d],!g){if('{'===k){'{'==h&&(f.hasBinding=!0,j=f.raw.length,null!=f.values[j]&&j++,f.values[j]='',g=!0),d++;continue}else'{'==h&&(f.raw+=h);f.raw+=k}else{if('}'===k){'}'==h&&(g=!1),d++;continue}f.values[j]+=k}d++}return f.includesNonBindings=0<f.raw.length,f}var live={attr:function(c,d){return function(e){c.setAttribute(d,e)}},text:function(c){return function(d){c.nodeValue=d}},prop:function(c,d){return function(e){c[d]=e}},event:function(c,d,e,f){var g=f.raw;c.addEventListener(d,function(h){var j=e.read(g);j.value.call(j.model,h)})},each:function(c,d,e){var f=stamp(c),g=e.props()[0],h=d.read(g),j=document.createTextNode('');c.parentNode.replaceChild(j,c);var k=function(m){var n=new Map,p=new Map,q=function(u,v){var w=d.add(u).add({item:u,index:v}),x=f(w),y={item:u,nodes:slice.call(x.childNodes),scope:w,index:v};n.set(u,y),p.set(v,y);var z=p.get(v+1),A=j.parentNode;if(z){var B=z.nodes[0];A.insertBefore(x,B)}else A.appendChild(x)},r=function(u){var v=p.get(u);v&&(v.nodes.forEach(function(w){w.parentNode.removeChild(w)}),n.delete(v.item),p.delete(u))};m.forEach(q);var s=function(u,v){if('delete'===u.type)return void r(u.index);var w=n.get(v);if(w){var x=w.index,y=x!==u.index;if(y){w.scope.model.index=w.index=u.index;var z=p.get(u.index);z?p.set(x,z):p.delete(x),p.set(u.index,w);var A=p.get(u.index+1);A&&(A=A.nodes[0]);for(var B=w.nodes.length-1;0<=B;)j.parentNode.insertBefore(w.nodes[B],A),B--}}else r(u.index),q(v,u.index)};return on(m,arrayChange,s),function(){for(var u=0,v=m.length;u<v;u++)r(u);off(m,arrayChange,s),n=null,p=null}},l=k(h.value);on(h.model,g,function(m,n){l(),l=k(n)})},if:function(c,d){var e=stamp(c),f=!1,g={},h=document.createTextNode('');return c.parentNode.replaceChild(h,c),function(j){if(!!f){var m=h.parentNode,n=h.nextSibling;j?g.children.forEach(function(p){m.insertBefore(p,n)}):g.children.forEach(function(p){m.removeChild(p)})}else if(j){var k=d.add(j),l=e(k);g.children=slice.call(l.childNodes),g.scope=k,h.parentNode.insertBefore(l,h.nextSibling),f=!0}}}};function setupBinding(c,d,e){var f=d.compute(c),g=function(){e(f())};d.props().forEach(function(h){var j=c.readInTransaction(h);j.model,!1!==j.bindable&&j.reads.forEach(function(k){on(k[0],k[1],g)})}),g()}function inspect(c,d,e){var f={};switch(c.nodeType){// Element
case 1:var g;if('TEMPLATE'===c.nodeName&&(g=specialTemplateAttr(c))){var h=parse(c.getAttribute(g));h.hasBinding&&(h.throwIfMultiple(),f[g]=!0,e[d.id]=function(k,l){'each'===g?live.each(k,l,h,k):setupBinding(l,h,live[g](k,l))})}break;// TextNode
case 3:var h=parse(c.nodeValue);h.hasBinding&&(e[d.id]=function(k,l){setupBinding(l,h,live.text(k))});}forEach.call(c.attributes||[],function(k){if(d.id++,!f[k.name]){var l=k.name,m=propAttr(l),n=parse(k.value);if(n.hasBinding)e[d.id]=function(s,x){return m?(s.removeAttribute(l),void setupBinding(x,n,live.prop(s,m))):void setupBinding(x,n,live.attr(s,l))};else if(m)e[d.id]=function(s){s.removeAttribute(l),live.prop(s,m)(k.value)};else if('on-'===l.substr(0,3)){var p=l.substr(3);e[d.id]=function(s,x){s.removeAttribute(l),live.event(s,p,x,n)}}}});var j=c.childNodes;return forEach.call(j,function(k){d.id++,inspect(k,d,e)}),e}var specialTemplateAttrs=['if','each'];function specialTemplateAttr(c){var d;for(var e=0,f=specialTemplateAttrs.length;e<f;e++)if(d=specialTemplateAttrs[e],c.getAttribute(d))return d}function propAttr(c){return c&&':'===c[0]&&c.substr(1)}var stamp=function(c){c=c instanceof HTMLTemplateElement?c:document.querySelector(c);var d=inspect(c.content,{id:0},{});return function(e){e instanceof Scope||(e=new Scope(e));var f=document.importNode(c.content,!0);return hydrate(f,d,e),f}};function Bram(c){return class extends c{constructor(){super();var d=this.constructor;let e=d.template;e&&(this._hydrate=stamp(e)),this._hasRendered=!1,this.model={};let f=d.events;f&&!d._hasSetupEvents&&installEvents(d)}connectedCallback(){if(this._hydrate&&!this._hasRendered){isModel(this.model)||(this.model=toModel(this.model));var d=new Scope(this).add(this.model),e=this._hydrate(d),f=this.constructor.renderMode;'light'===f?this.appendChild(e):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(e))}this.childrenConnectedCallback&&(this._disconnectChildMO=setupChildMO(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO()}}}var Element=Bram(HTMLElement);Bram.Element=Element,Bram.model=toModel,Bram.on=on,Bram.off=off,Bram.template=stamp;function installEvents(c){c._hasSetupEvents=!0,c.events().forEach(function(d){Object.defineProperty(c.prototype,'on'+d,{get:function(){return this['_on'+d]},set:function(e){var f='_on'+d,g=this[f];g&&this.removeEventListener(d,g),this[f]=e,this.addEventListener(d,e)}})})}var SUPPORTS_MO='function'==typeof MutationObserver;function setupChildMO(c){var d=!1,e=function(){d||c.childrenConnectedCallback()};if(!SUPPORTS_MO)return void asap(e);var f=new MutationObserver(e);return f.observe(c,{childList:!0}),c.childNodes.length&&asap(e),function(){d=!0,f.disconnect()}}export{Element};export default Bram;

