import createInstance,{AttributeTemplatePart,InnerTemplatePart,NodeTemplatePart,TemplateProcessor}from'@matthewp/template-instantiation';var symbol='function'==typeof Symbol?Symbol:function(a){return'@@-'+a},asap='function'==typeof Promise?a=>Promise.resolve().then(a):a=>setTimeout(()=>a(),0);class Transaction{static add(a){this.current=a,this.stack.push(a)}static remove(){this.stack.pop(),this.current=this.stack[this.stack.length-1]}static observe(a,b){this.current&&this.current.stack.push([a,b])}constructor(){this.stack=[]}start(){Transaction.add(this)}stop(){return Transaction.remove(),this.stack}}Transaction.stack=[];function isArraySet(a,b){return Array.isArray(a)&&!isNaN(+b)}function isArrayOrObject(a){return Array.isArray(a)||'object'==typeof a}function observe(a,b){var c=new Proxy(a,{get:function(d,e){return Transaction.observe(c,e),d[e]},set:function(d,e,f){var g=d[e];// If the value hasn't changed, nothing else to do
return!(!isModel(f)&&isArrayOrObject(f)&&(f=toModel(f)),d[e]=f,f!==g)||(isArraySet(d,e)?b({prop:arrayChange,index:+e,type:'set'},f):b({prop:e,type:'set'},f),!0)},deleteProperty:function(d,e){return isArraySet(d,e)&&b({prop:arrayChange,index:+e,type:'delete'}),!0}});return c}var events=symbol('bram-events'),arrayChange=symbol('bram-array-change'),toModel=function(a,b){return isModel(a)?a:(a=deepModel(a,b)||{},Object.defineProperty(a,events,{value:{},enumerable:!1}),observe(a,function(c,d){var e=a[events][c.prop];e&&e.forEach(function(f){f(c,d)})}))};function deepModel(a){return a?Object.keys(a).reduce(function(b,c){var d=a[c];return b[c]=Array.isArray(d)||'object'==typeof d?toModel(d):d,b},a):a}var isModel=function(a){return a&&!!a[events]},on=function(a,b,c){var d=a[events];if(d){var e=d[b];e||(e=d[b]=[]),e.push(c)}},off=function(a,b,c){var d=a[events];if(d){var e=d[b];if(e){var f=e.indexOf(c);-1===f||(e.splice(f,1),!e.length&&delete d[b])}}};class Scope{constructor(a,b){this.model=a,this.parent=b}read(a){return this._read(a)||{model:this.model,value:void 0}}readInTransaction(a){var b=new Transaction;b.start();var c=this.read(a);return c.reads=b.stop(),c}_read(a){var b=this.model,c=b[a];if(null==c){// Handle dotted bindings like "user.name"
var d=a.split('.');if(1<d.length)do c=b[d.shift()],d.length&&(b=c);while(d.length&&c)}return null==c?this.parent?this.parent.read(a):void 0:{model:b,value:c}}add(a){var b;return b=isModel(a)?a:Array.isArray(a)||'object'==typeof a?toModel(a):a,new Scope(b,this)}}function createTemplate(a){let b='string'==typeof a?document.querySelector(a):a;return function(c){let d=c;c instanceof Scope||(d=new Scope(c));let e=new BramProcessor;return createInstance(b,e,d)}}class BramProcessor extends TemplateProcessor{createdCallback(){}processCallback(a,b){for(const c of a)if(c instanceof InnerTemplatePart);else if(c instanceof NodeTemplatePart){const{expression:d}=c.rule;c.value=b&&d&&b[d]}else if(c instanceof AttributeTemplatePart){const{expressions:d}=c.rule;c.value=b&&d&&d.map(e=>b&&b[e])}}}function Bram(a){return class extends a{constructor(){super();var b=this.constructor;this._hasRendered=!1,this.model={},this._hydrate=b.template&&createTemplate(b.template);let c=b.events;c&&!b._hasSetupEvents&&installEvents(b);let d=!b._hasInstalledProps&&b.observedProperties;d&&(b._hasInstalledProps=!0,installProps(b,d,b.observedAttributes))}connectedCallback(){if(this._hydrate&&!this._hasRendered){isModel(this.model)||(this.model=toModel(this.model));let b=new Scope(this).add(this.model);this._template=this._hydrate(b);let c=this.constructor.renderMode;'light'===c?(this.innerHTML='',this.appendChild(this._template)):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(this._template)),this._hasRendered=!0}this.childrenConnectedCallback&&(this._disconnectChildMO=setupChildMO(this))}disconnectedCallback(){this._disconnectChildMO&&this._disconnectChildMO(),this._link&&this._link.detach()}attributeChangedCallback(b,c,d){var e=this.constructor._syncedAttrs,f=e&&e[b];f&&this[b]!==d&&(this[b]=d)}}}var Element=Bram(HTMLElement);Bram.Element=Element,Bram.model=toModel,Bram.on=on,Bram.off=off,Bram.template=createTemplate;function installEvents(a){a._hasSetupEvents=!0,a.events.forEach(function(b){Object.defineProperty(a.prototype,'on'+b,{get:function(){return this['_on'+b]},set:function(c){var d='_on'+b,e=this[d];e&&this.removeEventListener(b,e),this[d]=c,this.addEventListener(b,c)}})})}function installProps(a,b,c=[]){a._syncedAttrs={};var d=a.prototype;b.forEach(function(e){var f=Object.getOwnPropertyDescriptor(d,e);if(!f){var g=-1!==c.indexOf(e);g&&(a._syncedAttrs[e]=!0),Object.defineProperty(d,e,{get:function(){return this.model[e]},set:function(h){if(this.model[e]=h,g){var i=this.getAttribute(e);'boolean'==typeof h?h&&''!==i?this.setAttribute(e,''):''===i&&!h&&this.removeAttribute(e):i!==h&&this.setAttribute(e,h)}}})}})}var SUPPORTS_MO='function'==typeof MutationObserver;function setupChildMO(a){var b=!1,c=function(){b||a.childrenConnectedCallback()};if(!SUPPORTS_MO)return void asap(c);var d=new MutationObserver(c);return d.observe(a,{childList:!0}),a.childNodes.length&&asap(c),function(){b=!0,d.disconnect()}}export{Element};export default Bram;

