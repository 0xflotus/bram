var symbol='function'==typeof Symbol?Symbol:function(a){return'@@-'+a},values=Object.values||function(a){return Object.keys(a).reduce(function(b,c){return b.push(a[c]),b},[])},forEach=Array.prototype.forEach,some=Array.prototype.some,slice=Array.prototype.slice;function isArraySet(a,b){return Array.isArray(a)&&!isNaN(+b)}function isArrayOrObject(a){return Array.isArray(a)||'object'==typeof a}function observe(a,b){return new Proxy(a,{set:function(c,d,e){var f=c[d];// If the value hasn't changed, nothing else to do
return!(!isModel(e)&&isArrayOrObject(e)&&(e=toModel(e)),c[d]=e,e!==f)||(isArraySet(c,d)?b({prop:arrayChange,index:+d,type:'set'},e):b({prop:d,type:'set'},e),!0)},deleteProperty:function(c,d){return isArraySet(c,d)&&b({prop:arrayChange,index:+d,type:'delete'}),!0}})}var events=symbol('bram-events'),arrayChange=symbol('bram-array-change'),toModel=function(a,b){return a=deepModel(a,b)||{},Object.defineProperty(a,events,{value:{},enumerable:!1}),observe(a,function(c,d){var e=a[events][c.prop];e&&e.forEach(function(f){f(c,d)})})};function deepModel(a){return a?Object.keys(a).reduce(function(b,c){var d=a[c];return b[c]=Array.isArray(d)||'object'==typeof d?toModel(d):d,b},a):a}var isModel=function(a){return a&&!!a[events]},on=function(a,b,c){var d=a[events];if(d){var e=d[b];e||(e=d[b]=[]),e.push(c)}},off=function(a,b,c){var d=a[events];if(d){var e=d[b];if(e){var f=e.indexOf(c);-1===f||(e.splice(f,1),!e.length&&delete d[b])}}};function Scope(a,b){this.model=a,this.parent=b}Scope.prototype.read=function(a){return this._read(a)||{model:this.model,value:void 0}},Scope.prototype._read=function(a){var b=this.model[a];return null==b?this.parent?this.parent.read(a):void 0:{model:this.model,value:b}},Scope.prototype.add=function(a){var b;return b=isModel(a)?a:Array.isArray(a)||'object'==typeof a?toModel(a):a,new Scope(b,this)};function hydrate(a,b,c){function d(j){if(h++,g===h){var k=b[g];k(j,c),g=+f.shift()}return!g}function e(j){var k;return(some.call(j.attributes||[],function(){if(k=d(j),k)return!0}),!k)&&(some.call(j.childNodes,function(l){return(k=d(l),!!k)||(k=!e(l),!!k)||void 0}),!k)}var f=Object.keys(b),g=+f.shift(),h=0;e(a)}function ParseResult(){this.values={},this.raw='',this.hasBinding=!1,this.includesNonBindings=!1}ParseResult.prototype.getValue=function(a){var b=this.props()[0];return a.read(b).value},ParseResult.prototype.getStringValue=function(a){for(var d,e,b=Object.keys(this.values).sort(),c=this.raw;b.length;)d=b.pop(),e=a.read(this.values[d]).value,c=e?c.substr(0,d)+e+c.substr(d):void 0;return c},ParseResult.prototype.compute=function(a){var b=this.includesNonBindings||1<this.count();return b?this.getStringValue.bind(this,a):this.getValue.bind(this,a)},ParseResult.prototype.props=function(){return values(this.values)},ParseResult.prototype.count=function(){return!1===this.hasBinding?0:Object.keys(this.values).length},ParseResult.prototype.throwIfMultiple=function(a){if(1<this.count())throw a=a||'Only a single binding is allowed in this context.',new Error(a)};function parse(a){for(var h,b=0,c=a.length,d=new ParseResult,e=!1,f='',g=0;b<c;){if(f=h,h=a[b],!e){if('{'===h){'{'==f&&(d.hasBinding=!0,g=d.raw.length,null!=d.values[g]&&g++,d.values[g]='',e=!0),b++;continue}d.raw+=h}else{if('}'===h){'}'==f&&(e=!1),b++;continue}d.values[g]+=h}b++}return d.includesNonBindings=0<d.raw.length,d}var live={attr:function(a,b){return function(c){a.setAttribute(b,c)}},text:function(a){return function(b){a.nodeValue=b}},prop:function(a,b){return function(c){a[b]=c}},event:function(a,b,c,d){var e=d.raw;a.addEventListener(b,function(f){var g=c.read(e);g.value.call(g.model,f)})},each:function(a,b,c){var d=stamp(a),e=c.props()[0],f=b.read(e),g=document.createTextNode('');a.parentNode.replaceChild(g,a);var h=function(k){var l=new Map,m=new Map,n=function(r,s){var t=b.add(r).add({item:r,index:s}),u=d(t),v={item:r,nodes:slice.call(u.childNodes),scope:t,index:s};l.set(r,v),m.set(s,v);var w=m.get(s+1),x=g.parentNode;if(w){var y=w.nodes[0];x.insertBefore(u,y)}else x.appendChild(u)},p=function(r){var s=m.get(r);s&&(s.nodes.forEach(function(t){t.parentNode.removeChild(t)}),l.delete(s.item),m.delete(r))};k.forEach(n);var q=function(r,s){if('delete'===r.type)return void p(r.index);var t=l.get(s);if(t){var u=t.index,v=u!==r.index;if(v){t.scope.model.index=t.index=r.index;var w=m.get(r.index);w?m.set(u,w):m.delete(u),m.set(r.index,t);var x=m.get(r.index+1);x&&(x=x.nodes[0]);for(var y=t.nodes.length-1;0<=y;)g.parentNode.insertBefore(t.nodes[y],x),y--}}else p(r.index),n(s,r.index)};return on(k,arrayChange,q),function(){for(var r=0,s=k.length;r<s;r++)p(r);off(k,arrayChange,q),l=null,m=null}},j=h(f.value);on(f.model,e,function(k,l){j(),j=h(l)})},if:function(a,b){var c=stamp(a),d=!1,e={},f=document.createTextNode('');return a.parentNode.replaceChild(f,a),function(g){if(!!d){var k=f.parentNode,l=f.nextSibling;g?e.children.forEach(function(m){k.insertBefore(m,l)}):e.children.forEach(function(m){k.removeChild(m)})}else if(g){var h=b.add(g),j=c(h);e.children=slice.call(j.childNodes),e.scope=h,f.parentNode.insertBefore(j,f.nextSibling),d=!0}}}};function setupBinding(a,b,c){var d=b.compute(a),e=function(){c(d())};b.props().forEach(function(f){var g=a.read(f),h=g.model;!1!==g.bindable&&on(h,f,e)}),e()}function inspect(a,b,c){var d={};switch(a.nodeType){// Element
case 1:var e;if('TEMPLATE'===a.nodeName&&(e=specialTemplateAttr(a))){var f=parse(a.getAttribute(e));f.hasBinding&&(f.throwIfMultiple(),d[e]=!0,c[b.id]=function(h,j){'each'===e?live.each(h,j,f,h):setupBinding(j,f,live[e](h,j))})}break;// TextNode
case 3:var f=parse(a.nodeValue);f.hasBinding&&(c[b.id]=function(h,j){setupBinding(j,f,live.text(h))});}forEach.call(a.attributes||[],function(h){if(b.id++,!d[h.name]){var j=h.name,k=isPropAttr(j),l=parse(h.value);if(l.hasBinding)c[b.id]=function(q,u){return k?(q.removeAttribute(j),void setupBinding(u,l,live.prop(q,j.substr(1)))):void setupBinding(u,l,live.attr(q,j))};else if(k);else if('on-'===j.substr(0,3)){var m=j.substr(3);c[b.id]=function(q,u){q.removeAttribute(j),live.event(q,m,u,l)}}}});var g=a.childNodes;return forEach.call(g,function(h){b.id++,inspect(h,b,c)}),c}var specialTemplateAttrs=['if','each'];function specialTemplateAttr(a){var b;for(var c=0,d=specialTemplateAttrs.length;c<d;c++)if(b=specialTemplateAttrs[c],a.getAttribute(b))return b}function isPropAttr(a){return a&&':'===a[0]}var stamp=function(a){a=a instanceof HTMLTemplateElement?a:document.querySelector(a);var b=inspect(a.content,{id:0},{});return function(c){c instanceof Scope||(c=new Scope(c));var d=document.importNode(a.content,!0);return hydrate(d,b,c),d}};function Bram(a){return class extends a{constructor(){super();var b=this.constructor;let c=b.template;c&&(this._hydrate=stamp(c())),this._hasRendered=!1;let d=b.events;d&&!b._hasSetupEvents&&installEvents(b)}connectedCallback(){if(this._hydrate&&!this._hasRendered){this.model=toModel(this,!0);var b=this._hydrate(this.model),c=this.constructor.renderMode;'light'===c?this.appendChild(b):(this.attachShadow({mode:'open'}),this.shadowRoot.appendChild(b))}}}}var Element=Bram(HTMLElement);Bram.Element=Element,Bram.model=toModel,Bram.template=stamp;function installEvents(a){a._hasSetupEvents=!0,a.events().forEach(function(b){Object.defineProperty(a.prototype,'on'+b,{get:function(){return this['_on'+b]},set:function(c){var d='_on'+b,e=this[d];e&&this.removeEventListener(b,e),this[d]=c,this.addEventListener(b,c)}})})}export{Element};export default Bram;

